[virtual_sdcard]
path: /home/pi/gcode_files

[pause_resume]

[display_status]

[respond]
default_type: echo

[delayed_gcode clear_display]
gcode:
  M117 # clear display message


[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
  PRINT_END2
  TURN_OFF_HEATERS
  CLEAR_PAUSE
  CANCEL_PRINT_BASE


[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
gcode:
  PAUSE_BASE
  DISABLE_XY
  _TOOLHEAD_PARK_PAUSE_CANCEL


[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
  {% if printer["filament_switch_sensor door_closed"].filament_detected != True %}
    action_respond_info("Door opened, cannot resume")
  {% else %}
    G28 X
    G28 Y
    ##### read extrude from  _TOOLHEAD_PARK_PAUSE_CANCEL  macro #####
    {% set extrude = printer['gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL'].extrude %}
    #### get VELOCITY parameter if specified ####
    {% if 'VELOCITY' in params|upper %}
      {% set get_params = ('VELOCITY=' + params.VELOCITY)  %}
    {%else %}
      {% set get_params = "" %}
    {% endif %}
    ##### end of definitions #####
    {% if printer.extruder.can_extrude|lower == 'true' %}
      M83
      G1 E{extrude} F2100
      {% if printer.gcode_move.absolute_extrude |lower == 'true' %} M82 {% endif %}
    {% else %}
      {action_respond_info("Extruder not hot enough")}
    {% endif %}  
    RESUME_BASE {get_params}
  {% endif %}


[gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL]
description: Helper: park toolhead used in PAUSE and CANCEL_PRINT
variable_extrude: 25.0
gcode:
  ##### set park positon for x and y #####
  # default is your max posion from your printer.cfg
  {% set x_park = printer.toolhead.axis_maximum.x|float - 5.0 %}
  {% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}
  {% set z_park_delta = 5.0 %}
  ##### calculate save lift position #####
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% if act_z < (max_z - z_park_delta) %}
    {% set z_safe = z_park_delta %}
  {% else %}
    {% set z_safe = max_z - act_z %}
  {% endif %}
  ##### end of definitions #####
  {% if printer.extruder.can_extrude|lower == 'true' %}
    M83
    G1 E-{extrude} F2100
    {% if printer.gcode_move.absolute_extrude |lower == 'true' %} M82 {% endif %}
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}
  {% if "xyz" in printer.toolhead.homed_axes %}
    G91
    G1 Z{z_safe} F900
    G90
    G1 X{x_park} Y{y_park} F6000
    {% if printer.gcode_move.absolute_coordinates|lower == 'false' %} G91 {% endif %}
  {% else %}
    {action_respond_info("Printer not homed")}
  {% endif %}

    
[gcode_macro PRINT_START]
description: Helper: Use PRINT_START for the slicer starting script 
gcode:
#Parameters
    {% set bedtemp = params.BED|int %}
    {% set hotendtemp = params.HOTEND|int %}
    {% set chambertemp = params.CHAMBER|default(0)|int %}
#Homing procedure 
    G28
    G90
    G0 X400 Y0 Z50 F6000
    M104 S{hotendtemp}
    M190 S{bedtemp}
    M109 S{hotendtemp}
    SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET={chambertemp}
    G32
    G29
    LIGHTS_ON


[gcode_macro PRIME_NOZZLE]
gcode:
#prime the nozzle
    G90
    G0 X400 Y0.25 Z50 F6000
    G92 E0
    G90
    G0 Z0.5
    G1 X50 E80 F800
    G1 X40 Y0 F15000
    G1 X390 Y0 F15000
    G1 X60 Y.5 F15000
    G0 Z0.8
    G92 E0
    G90


[gcode_macro PRINT_END]
description: Helper: Use PRINT_END for the slicer ending script
gcode:
    SAVE_GCODE_STATE NAME=end_print_state
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-35 F3600                ; retract filament
    G91                            ; relative positioning
    G0 Z1.00 X2.0 Y2.0 F20000    ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G1 Z10 F3000                    ; move nozzle up 2mm
    G90                            ; absolute positioning
    G0  X400 Y395 F3600       ; park nozzle at center rear
    LIGHTS_ON
    M117 Print Done :)
    RESPOND MSG=" Print Done :)"
    RESTORE_GCODE_STATE NAME=end_print_state
    #PRINT_END_COOLDOWN	

[gcode_macro PRINT_END2]
description: Helper: Ran when forcing cancel print
gcode:
    SAVE_GCODE_STATE NAME=end_print_state
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-25 F3600                ; retract filament
    G91                            ; relative positioning
    G0 Z1.00 X2.0 Y2.0 F20000    ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G1 Z20 F3000                    ; move nozzle up 2mm
    G90                            ; absolute positioning
    G0  X200 Y370 F3600       ; park nozzle at center rear
    LIGHTS_ON
    M117 Print Done :)
    RESPOND MSG=" Print Cancelled :("
    RESTORE_GCODE_STATE NAME=end_print_state
    #PRINT_END_COOLDOWN

[gcode_macro PRINT_END_COOLDOWN]
gcode:
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=25
  SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET=25
  SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=Duet_WiFi TARGET=25
  G4 P600000
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
  SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET=0
  SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=Duet_WiFi TARGET=0 

[gcode_macro UNLOAD_FILAMENT]
description: Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode:
  SAVE_GCODE_STATE NAME=unload_state
  G91
  {% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
    M117 Heating...
    # Heat up hotend to provided temp or 220 as default as that should work OK with most filaments.
    M104 S{params.TEMP|default(220, true)}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
  {% endif %}
  M117 Unloading filament...
  # Extract filament to cold end area 
  G0 E-5 F3600
  # Wait for three seconds
  G4 P3000
  # Push back the filament to smash any stringing 
  G0 E5 F3600
  # Extract back fast in to the cold zone 
  G0 E-15 F3600
  # Continue extraction slowly, allow the filament time to cool solid before it reaches the gears       
  G0 E-130 F300
  M400e
  M117 Filament unloaded!
  RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
  RESTORE_GCODE_STATE NAME=unload_state


[gcode_macro LOAD_FILAMENT]
description: Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode:
  SAVE_GCODE_STATE NAME=load_state
  G91
  # Heat up hotend to provided temp or 220 as default as that should work OK with most filaments.
  {% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
    M117 Heating...
    M104 S{params.TEMP|default(220, true)}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
  {% endif %}
  M117 Loading filament...
  # Load the filament into the hotend area.
  G0 E100 F600
  # Wait a secod
  G4 P1000
  # Purge
  G0 E40 F100
  # Wait for purge to complete
  M400e
  M117 Filament loaded!
  RESPOND MSG="Filament loaded!"
  RESTORE_GCODE_STATE NAME=load_state


[idle_timeout]
gcode:
    LIGHTS_OFF
    M84
    TURN_OFF_HEATERS
timeout: 3600 # seconds 3 days = 259200 SET AT YOUR OWN RISK


[gcode_macro LIGHTS_OFF]
gcode:    
    SET_LED LED=lights RED=0 GREEN=0 BLUE=0
    

[gcode_macro LIGHTS_ON]
gcode:    
    SET_LED LED=lights RED=1 GREEN=1 BLUE=1

[gcode_macro G29]
gcode:
  BED_MESH_CALIBRATE PROFILE=default
  BED_MESH_PROFILE LOAD=default

[gcode_macro G32]
gcode:
    BED_MESH_CLEAR
    G28
    QUAD_GANTRY_LEVEL
    G28
    G0 X150 Y150 Z20 F18000 
	
	
[gcode_macro BELT_TENSION_XY]
gcode:
    G32
    G1 X200 Y107.5 F3600
    G1 Z150


[gcode_macro BELT_TENSION_Z]
gcode:
    G32
    G1 X200 Y200 F3600
    G1 Z412 
 
	
[gcode_macro DISABLE_XY]
gcode:	
    SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=0
    SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=0	


[gcode_macro EXTRUDER_CALIBRATION]
gcode:
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=260
  M109 S260
  G91
  G1 E100 F100
  G90
  
  
[gcode_macro M600]
description: Executes a color change by pausing the printer an unloading the filament.
gcode:
  PAUSE
  UNLOAD_FILAMENT
  M117 Please load new filament and resume
  RESPOND MSG="Please load new filament and resume"


[gcode_macro PartyTime]
gcode:
	SET_LED LED=lights RED=0 GREEN=1 BLUE=0
	SET_LED LED=lights RED=0 GREEN=0 BLUE=1
        SET_LED LED=lights RED=1 GREEN=0 BLUE=0 INDEX=1 TRANSMIT=0
        SET_LED LED=lights RED=1 GREEN=0 BLUE=0 INDEX=1
	G4 P250                       ; sleep 250ms                    
	SET_LED LED=lights RED=0 GREEN=1 BLUE=0
	SET_LED LED=lights RED=0 GREEN=0 BLUE=1
        SET_LED LED=lights RED=0 GREEN=1 BLUE=0 INDEX=1 TRANSMIT=0
        SET_LED LED=lights RED=0 GREEN=1 BLUE=0 INDEX=1

[gcode_macro SIREN]
gcode:
	SET_LED LED=lights RED=1 GREEN=0 BLUE=0
	SET_LED LED=lights RED=0 GREEN=0 BLUE=1
        SET_LED LED=lights RED=1 GREEN=0 BLUE=0 INDEX=1 TRANSMIT=0
        SET_LED LED=lights RED=1 GREEN=0 BLUE=0 INDEX=1
	G4 P250                       ; sleep 250ms                    
	SET_LED LED=lights RED=1 GREEN=0 BLUE=0
	SET_LED LED=lights RED=0 GREEN=0 BLUE=1
        SET_LED LED=lights RED=1 GREEN=0 BLUE=0 INDEX=1 TRANSMIT=0
        SET_LED LED=lights RED=1 GREEN=0 BLUE=0 INDEX=1
